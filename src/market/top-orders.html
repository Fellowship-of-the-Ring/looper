<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<dom-module id="top-orders" fit>
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles">
         :host {
            display: block;
        }

        .seperator {
            width: 60px;
        }

        vaadin-grid {
            line-height: inherit;
            text-transform: uppercase;
        }

        h3 {
            font-size: 14px;
        }

        .bid {
            color: var(--app-green-color);
        }

        .ask {
            color: var(--app-red-color);
        }
        </style>
        <iron-ajax auto url="//raw.githubusercontent.com/Loopring/mock-relay-data/master/orderbook.json" handle-as="json" last-response="{{resp}}"></iron-ajax>
        <!-- The array is set as the <vaadin-grid>'s "items" property -->
        <global-variable key="app-config" value="{{appConfig}}"></global-variable>
        <div class="horizontal layout">
            <div class="asks flex">
                <div class="horizontal center-justified layout">
                    <h3>Bids</h3></div>
                <div>
                    <!--  <vaadin-grid aria-label="Basic Binding Example" items="[[resp.result.data]]">
                        <vaadin-grid-column width="50px">
                            <template class="header">Amount</template>
                            <template>[[numberFormat(item.orginalOrder.amountB)]] [[item.orginalOrder.tokenB]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="50px">
                            <template class="header">Price</template>
                            <template><span class="bid">[[getPrice(item.orginalOrder.amountS,item.orginalOrder.amountB)]]</span></template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="50px">
                            <template class="header">Size</template>
                            <template>[[numberFormat(item.orginalOrder.amountS)]] [[item.orginalOrder.tokenS]]
                            </template>
                        </vaadin-grid-column>
                    </vaadin-grid> -->
                </div>
            </div>
            <div class="seperator"></div>
            <div class="bids flex">
                <div class="horizontal center-justified layout">
                    <h3>Asks</h3></div>
                <div>
                    <vaadin-grid aria-label="Basic Binding Example" items="[[processed.asks]]">
                        <vaadin-grid-column width="50px">
                            <template class="header">Amount</template>
                            <template>[[item.size]] [[tokenxConfig.unit]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="50px">
                            <template class="header">Price</template>
                            <template><span class="ask">[[item.price]] [[priceUnit]]</span></template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="50px">
                            <template class="header">Size</template>
                            <template>[[item.total]] [[tokenyConfig.unit]]
                            </template>
                        </vaadin-grid-column>
                    </vaadin-grid>
                </div>
            </div>
        </div>
    </template>
    <script>
    class TopOrders extends Polymer.Element {
        static get is() {
            return 'top-orders';
        }

        static get properties() {
            return {
                resp: Object,
                processed: {
                    type: Object,
                    computed: '_process(resp)'
                },
                tokenx: String,
                tokeny: String,
                market: {
                    type: String,
                    computed: '_computeMarketId(tokenx, tokeny)'
                }
            };
        }

        _computeMarketId(tokenx, tokeny) {
            return tokenx + "-" + tokeny;
        }

        _process(resp) {
             console.log("=============" + resp)
            if (resp) {
                console.log(resp);
                this.tokenxConfig = this.appConfig.tokenMap[this.tokenx];
                this.tokenyConfig = this.appConfig.tokenMap[this.tokeny];
                this.marketConfig = this.appConfig.marketMap[this.market];
                console.log(this.marketConfig)
                this.priceUnit = this.tokenxConfig.unit + "/" + this.tokenyConfig.unit;

                console.log(this.priceUnit)

                const f = function(i) {
                    var item = {};
                    item.price = this.appConfig.formatPrice(i.price, this.marketConfig);
                    item.size = this.appConfig.formatValue(i.size, this.tokenxConfig);
                    item.total = this.appConfig.formatValue(i.size * i.price, this.tokenyConfig);
                    return item;
                }.bind(this);

                var processed = {};
                processed.asks = _.map(resp.asks, f);
                processed.bids = _.map(resp.bids, f);

                 console.log(processed);
                return processed;
            }
        }
    }

    window.customElements.define(TopOrders.is, TopOrders);
    </script>
</dom-module>